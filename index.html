<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="HM Barcode">
<meta name="theme-color" content="#f0f4f8">
<title>HM Barcode Checker</title>
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<style>
:root {
  --safe-b: env(safe-area-inset-bottom, 0px);
  --primary: #1e88e5;
  --primary-dark: #1565c0;
  --bg-color: #f0f4f8;
  --surface: #ffffff;
  --text-main: #2c3e50;
  --text-sub: #7f8c8d;
  --border-light: #e1e8ed;
}

* { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
body { font-family:-apple-system, BlinkMacSystemFont, 'Apple SD Gothic Neo', 'Noto Sans KR', sans-serif; background:var(--bg-color); color:var(--text-main); min-height:100vh; min-height:100dvh; -webkit-text-size-adjust:100%; overflow-x:hidden; }
.page { display:none; min-height:100vh; min-height:100dvh; padding-bottom:calc(90px + var(--safe-b)); animation: fadeIn 0.3s ease-out; }
.page.active { display:block; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

/* 모던 패널 디자인 */
.panel { background: var(--surface); border-radius: 16px; margin-bottom: 20px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.04); border: 1px solid rgba(0,0,0,0.02); }
.panel-header { background: linear-gradient(135deg, var(--primary), #42a5f5); color: #fff; padding: 16px; font-size: 16px; font-weight: 700; display: flex; align-items: center; gap: 10px; }
.panel-header svg { width: 20px; height: 20px; fill: none; stroke: currentColor; stroke-width: 2.5; stroke-linecap: round; stroke-linejoin: round; }
.panel-body { padding: 0; }
.panel-body.content-box { padding: 16px; font-family: 'SF Mono', Menlo, monospace; font-size: 14px; line-height: 1.6; word-break: break-all; white-space: pre-line; background: #fafbfc; }

/* 데이터 하이라이트 */
.highlight-yellow { background: rgba(255, 235, 59, 0.4); font-weight: bold; border-radius: 4px; padding: 2px 0; }
.gs { color:#e53935; font-weight:bold; } .rs { color:#43a047; font-weight:bold; } .eot { color:#1e88e5; font-weight:bold; }

/* 모던 테이블 */
.result-table { width: 100%; border-collapse: collapse; font-size: 13px; }
.result-table th, .result-table td { border-bottom: 1px solid var(--border-light); border-right: 1px solid var(--border-light); padding: 12px 10px; vertical-align: middle; }
.result-table tr:last-child td { border-bottom: none; }
.result-table td:last-child { border-right: none; }
.result-table thead th { background: #f8fafc; color: var(--text-sub); font-weight: 700; text-align: center; border-bottom: 2px solid var(--border-light); }
.result-table .td-head { background: #f8fafc; text-align: center; font-weight: 600; color: var(--text-main); }
.result-table .td-center { text-align: center; }
.result-table .td-data { font-family: 'SF Mono', Menlo, monospace; font-weight: 600; color: var(--primary-dark); }
.txt-ok { color: #43a047; font-weight: 800; }
.txt-ng { color: #e53935; font-weight: 800; }

/* 하단 네비게이션 앱 스타일 */
.bottom-bar { position: fixed; bottom: 0; left: 0; right: 0; z-index: 40; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-top: 1px solid rgba(0,0,0,0.05); padding: 8px 16px; padding-bottom: calc(8px + var(--safe-b)); display: flex; justify-content: space-around; align-items: center; box-shadow: 0 -4px 20px rgba(0,0,0,0.03); }
.bottom-btn { display: flex; flex-direction: column; align-items: center; gap: 4px; background: transparent; color: var(--text-sub); font-size: 11px; font-weight: 600; border: none; cursor: pointer; padding: 8px; transition: all 0.2s; }
.bottom-btn svg { width: 24px; height: 24px; fill: currentColor; transition: transform 0.2s; }
.bottom-btn:active svg { transform: scale(0.9); }

/* 중앙 스캔 버튼 (Pulse 애니메이션) */
.scan-btn-wrapper { position: relative; top: -15px; }
.scan-btn-main { width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(135deg, var(--primary), #42a5f5); color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; border: none; box-shadow: 0 4px 15px rgba(30, 136, 229, 0.4); cursor: pointer; animation: pulse 2s infinite; }
.scan-btn-main svg { width: 28px; height: 28px; fill: white; margin-bottom: 2px; }
.scan-btn-main span { font-size: 10px; font-weight: bold; }
@keyframes pulse {
  0% { box-shadow: 0 0 0 0 rgba(30, 136, 229, 0.4); }
  70% { box-shadow: 0 0 0 15px rgba(30, 136, 229, 0); }
  100% { box-shadow: 0 0 0 0 rgba(30, 136, 229, 0); }
}

/* 뱃지 */
.pass-badge { margin-left: auto; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 800; color: #fff; letter-spacing: 0.5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
.pass-badge.ok { background: #43a047; }
.pass-badge.ng { background: #e53935; }

/* 텅 빈 화면 (SVG 애니메이션 적용) */
.content { padding: 20px 16px 0; }
.empty-state { text-align: center; padding: 80px 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
.empty-svg-wrapper { width: 120px; height: 120px; background: #fff; border-radius: 24px; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 30px rgba(0,0,0,0.05); margin-bottom: 20px; position: relative; overflow: hidden; }
.anim-barcode { fill: var(--text-sub); opacity: 0.5; }
.anim-laser { fill: #f44336; animation: laserScan 2s ease-in-out infinite; box-shadow: 0 0 10px #f44336; }
@keyframes laserScan { 0%, 100% { transform: translateY(-20px); opacity: 0; } 10%, 90% { opacity: 1; } 50% { transform: translateY(40px); } }
.empty-state .text { color: var(--text-sub); font-size: 15px; line-height: 1.6; font-weight: 500; }

/* 탭 바 */
.tab-bar { display: flex; gap: 10px; overflow-x: auto; padding: 0 0 16px; scrollbar-width: none; }
.tab-bar::-webkit-scrollbar { display: none; }
.tab-btn { padding: 10px 20px; border: none; background: #e1e8ed; color: var(--text-sub); border-radius: 20px; font-weight: 700; font-size: 14px; transition: all 0.3s; white-space: nowrap; }
.tab-btn.active { background: var(--primary); color: #fff; box-shadow: 0 4px 10px rgba(30, 136, 229, 0.3); }

/* 액션 카드 & 인풋 */
.text-input { width: 100%; height: 120px; border: 2px solid var(--border-light); border-radius: 12px; padding: 16px; font-size: 15px; resize: none; outline: none; transition: border-color 0.3s; }
.text-input:focus { border-color: var(--primary); }
.action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
.action-card { padding: 20px 10px; background: #f8fafc; border: 2px solid var(--border-light); border-radius: 12px; text-align: center; font-weight: 700; color: var(--text-main); cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; align-items: center; gap: 8px; }
.action-card svg { width: 28px; height: 28px; fill: var(--primary); }
.action-card:active { transform: scale(0.96); background: #eef2f6; }

/* 이력 리스트 */
.hist-item { background: #fff; border: 1px solid var(--border-light); padding: 16px; margin-bottom: 12px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.02); }
.hist-item .date { font-size: 12px; color: var(--text-sub); margin-bottom: 6px; font-weight: 500; }
.hist-item .code { font-size: 14px; font-family: monospace; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

/* 스캐너 UI 유지 */
.scanner-overlay{position:fixed;inset:0;z-index:100;background:#000;display:flex;flex-direction:column}
#qr-reader{position:absolute;inset:0;width:100%;height:100%}
#qr-reader video{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
.scan-ui{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none}
.scan-dim{position:absolute;inset:0;background:linear-gradient(to bottom,rgba(0,0,0,0.6) 0%,rgba(0,0,0,0.25) 35%,rgba(0,0,0,0.25) 65%,rgba(0,0,0,0.6) 100%)}
.scan-frame{position:relative;width:250px;height:250px;border:2px solid rgba(255,255,255,0.4); border-radius: 20px;}
.scan-line{position:absolute;left:0;right:0;height:3px;top:50%;background:#ff3b30;box-shadow:0 0 10px #ff3b30;animation:scanMove 2s ease-in-out infinite; border-radius: 3px;}
@keyframes scanMove{0%,100%{top:10%}50%{top:90%}}
.scan-bottom{position:absolute;bottom:0;left:0;right:0;background:rgba(0,0,0,0.8);padding:30px 20px; z-index:10; padding-bottom:calc(30px + var(--safe-b));}
.scan-stop{width:100%;padding:16px;background:#333;color:#fff;border:none;border-radius:12px;font-size:16px;font-weight:bold; transition: background 0.2s;}
.scan-stop:active { background: #555; }

.flash{position:fixed;inset:0;z-index:200;background:rgba(255,255,255,0.9);pointer-events:none;animation:fadeOut 0.5s ease-out forwards}
@keyframes fadeOut{from{opacity:1}to{opacity:0}}
#galleryInput{display:none}
</style>
</head>
<body>
<div id="page-main" class="page active">
  <div class="content">
    
    <div id="emptyState" class="empty-state">
      <div class="empty-svg-wrapper">
        <svg viewBox="0 0 100 100" width="60" height="60" xmlns="http://www.w3.org/2000/svg">
          <rect x="20" y="25" width="6" height="50" rx="3" class="anim-barcode" />
          <rect x="32" y="25" width="10" height="50" rx="3" class="anim-barcode" />
          <rect x="48" y="25" width="4" height="50" rx="3" class="anim-barcode" />
          <rect x="58" y="25" width="12" height="50" rx="3" class="anim-barcode" />
          <rect x="76" y="25" width="8" height="50" rx="3" class="anim-barcode" />
          <rect x="15" y="48" width="70" height="4" rx="2" class="anim-laser" />
        </svg>
      </div>
      <div class="text" id="emptyText">하단의 스캔 버튼을 눌러<br>바코드 검증을 시작하세요.</div>
    </div>
    
    <div id="tabSection" style="display:none"><div class="tab-bar" id="tabBar"></div></div>

    <div id="barcodeSection" class="panel" style="display:none">
      <div class="panel-header">
        <svg viewBox="0 0 24 24"><path d="M4 7h16M4 12h16M4 17h16"></path></svg>
        <span id="secBarcode">바코드 내용</span>
        <div id="passBadge" class="pass-badge" style="display:none"></div>
      </div>
      <div class="panel-body content-box" id="fullViewData"></div>
    </div>

    <div id="resultSection" class="panel" style="display:none">
      <div class="panel-header">
        <svg viewBox="0 0 24 24"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
        <span id="secResult">H/KMC부품 2D 바코드 표준</span>
      </div>
      <div class="panel-body">
        <table class="result-table" id="resultTable"></table>
      </div>
    </div>
  </div>

  <div class="bottom-bar">
    <button class="bottom-btn" onclick="showPage('language')">
      <svg viewBox="0 0 24 24"><path d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v2h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"/></svg>
      <span id="navLang">언어</span>
    </button>
    
    <div class="scan-btn-wrapper">
      <button class="scan-btn-main" onclick="showPage('input')">
        <svg viewBox="0 0 24 24"><path d="M3 5v4h2V5h4V3H5c-1.1 0-2 .9-2 2zm2 10H3v4c0 1.1.9 2 2 2h4v-2H5v-4zm14 4h-4v2h4c1.1 0 2-.9 2-2v-4h-2v4zm0-16h-4v2h4v4h2V5c0-1.1-.9-2-2-2z"/><path d="M5 11h14v2H5z"/></svg>
        <span id="navScan">스캔</span>
      </button>
    </div>

    <button class="bottom-btn" onclick="showPage('history')">
      <svg viewBox="0 0 24 24"><path d="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z"/></svg>
      <span id="navHist">이력</span>
    </button>
  </div>
</div>

<div id="page-input" class="page">
  <div class="content">
    <div class="panel">
      <div class="panel-header"><svg viewBox="0 0 24 24"><path d="M4 6h16M4 12h16M4 18h16"></path></svg><span id="inputTitle">바코드 입력</span></div>
      <div class="panel-body" style="padding:20px;">
        <div class="action-grid">
          <button class="action-card" onclick="startScan()">
            <svg viewBox="0 0 24 24"><path d="M3 5v4h2V5h4V3H5c-1.1 0-2 .9-2 2zm2 10H3v4c0 1.1.9 2 2 2h4v-2H5v-4zm14 4h-4v2h4c1.1 0 2-.9 2-2v-4h-2v4zm0-16h-4v2h4v4h2V5c0-1.1-.9-2-2-2z"/></svg>
            <span id="camCardLabel">실시간 스캔</span>
          </button>
          <button class="action-card" onclick="openGallery()">
            <svg viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>
            <span id="galCardLabel">사진 업로드</span>
          </button>
        </div>
        <input type="file" id="galleryInput" accept="image/*">
        <textarea class="text-input" id="manualInput" placeholder="바코드 데이터를 직접 입력하세요..."></textarea>
        <div style="margin-top:12px;text-align:right">
          <button onclick="analyzeManual()" style="padding:12px 24px;background:var(--primary);color:#fff;border:none;border-radius:8px;font-weight:700;font-size:15px;cursor:pointer;box-shadow:0 4px 10px rgba(30,136,229,0.3)" id="inputAnalyze">데이터 분석</button>
        </div>
      </div>
    </div>
  </div>
  <div class="bottom-bar" style="justify-content: center;">
    <button class="bottom-btn" onclick="showPage('main')" style="width:100%; max-width: 200px; background:#e1e8ed; border-radius:12px; padding:12px; font-size:14px;" id="inputCancel">메인으로 돌아가기</button>
  </div>
</div>

<div id="page-history" class="page">
  <div class="content">
    <div class="panel">
      <div class="panel-header"><svg viewBox="0 0 24 24"><path d="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9z"/></svg><span id="histPageTitle">바코드 이력</span></div>
      <div class="panel-body" style="padding:16px;" id="historyContent"></div>
    </div>
  </div>
  <div class="bottom-bar" style="gap:10px;">
    <button class="bottom-btn" style="flex:1; background:#ffebee; color:#e53935; border-radius:12px; padding:12px; font-size:14px;" onclick="clearHistory()" id="histClear">전체삭제</button>
    <button class="bottom-btn" style="flex:1; background:#e1e8ed; border-radius:12px; padding:12px; font-size:14px;" onclick="showPage('main')" id="histClose">닫기</button>
  </div>
</div>

<div id="page-language" class="page">
  <div class="content">
    <div class="panel">
      <div class="panel-header"><svg viewBox="0 0 24 24"><path d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v2h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04z"/></svg><span id="langPageTitle">언어 선택</span></div>
      <div class="panel-body">
        <div style="padding:18px 20px; border-bottom:1px solid var(--border-light); cursor:pointer; font-weight:600;" onclick="setLang('ko')">한국어 <span id="chkKo" style="float:right;display:none;color:var(--primary);font-weight:bold">✓</span></div>
        <div style="padding:18px 20px; cursor:pointer; font-weight:600;" onclick="setLang('en')">English <span id="chkEn" style="float:right;display:none;color:var(--primary);font-weight:bold">✓</span></div>
      </div>
    </div>
  </div>
  <div class="bottom-bar" style="justify-content: center;">
    <button class="bottom-btn" onclick="showPage('main')" style="width:100%; max-width: 200px; background:#e1e8ed; border-radius:12px; padding:12px; font-size:14px;" id="langClose">닫기</button>
  </div>
</div>

<div id="scannerOverlay" class="scanner-overlay" style="display:none">
  <div id="qr-reader"></div>
  <div class="scan-ui"><div class="scan-dim"></div><div class="scan-frame"><div class="scan-line"></div></div></div>
  <div class="scan-bottom"><button class="scan-stop" onclick="closeScanner()" id="stopScanBtn">스캔 중지</button></div>
</div>

<div id="flashEffect" class="flash" style="display:none"></div>

<script>
// 기존 자바스크립트 로직 (변경 없이 그대로 복사됨)
function DataAnalyzer(){
  var D=[],DL=[],RD=[],cnt=0,sel=0;
  this.setBarcodeData=function(s){D=[];DL=[];RD=[];cnt=0;sel=0;af(s);sd();};
  this.setSelectIndex=function(i){sel=i;};this.getSelectedIndex=function(){return sel;};
  
  this.getFullViewData=function(){
    var r='';
    DL.forEach(function(row,i){
      if(i===sel) r+='<span class="highlight-yellow">';
      row.forEach(function(v){r+=cc(v);});
      if(i===sel) r+='</span>';
    });
    return r;
  };
  
  this.getCount=function(){return cnt;};
  this.getCheckResult=function(){return dc();};this.getResultData=function(){return RD;};
  function af(s){D=[];for(var i=0;i<s.length;i++)if(s.charCodeAt(i)!==32)D.push(s.charCodeAt(i));}
  function sd(){var r=[];D.forEach(function(v){r.push(v);if(v===35){DL.push(r);r=[];cnt++;}});if(r.length>0){DL.push(r);cnt++;}}
  function lp(n,w){n=n+'';return n.length>=w?n:new Array(w-n.length+1).join('0')+n;}
  function cc(s){if(s===29)return'<span class="gs"><sup>G</sup><sub>S</sub></span>';if(s===30)return'<span class="rs"><sup>R</sup><sub>S</sub></span>';if(s===4)return'<span class="eot"><sup>E</sup>O<sub>T</sub></span>';if(s===35)return'#<br>';if((s>=0&&s<=32)||s===127)return'&lt;0x'+lp(s.toString(16).toUpperCase(),2)+'&gt;';return String.fromCharCode(s);}
  function ad(a){var r='';if(typeof a==='number')return cc(a);if(a)a.forEach(function(v){r+=cc(v);});return r;}
  function hc(a,c){return a.some(function(v){return v===c;});}
  function vd(a){var s='';a.forEach(function(v){s+=String.fromCharCode(v);});if(!/[0-9]{2}[0-1]{1}[0-9]{1}[0-9]{2}/.test(s))return false;var ld=[31,28,31,30,31,30,31,31,30,31,30,31],y=Number('20'+s.substr(0,2)),m=Number(s.substr(2,2)),d=Number(s.substr(4,2));if(m>12||m===0||d===0)return false;if(y%4===0&&(y%100!==0||y%400===0)&&m===2)return d<=29;return d<=ld[m-1];}
  function ba(a){if(!a||(Array.isArray(a)&&a.length===0))return false;var c=function(v){return v<47||(v>57&&v<65)||(v>90&&v<97)||v>122;};if(typeof a==='number')return c(a);for(var i=0;i<a.length;i++)if(c(a[i]))return true;return false;}
  function sg(a){var r=[],row=[];a.forEach(function(v){if(v===29){r.push(row.slice(0));row=[];}else row.push(v);});return r;}
  function fb(a){var c=-1;a.some(function(v,i){if(v===29){c=i;return true;}return false;});return a.slice(0,c);}
  function lb(a){var c=-1;for(var x=a.length;x>0;x--)if(a[x]===29){c=x+1;break;}return a.slice(c);}
  function dd(t,ok,d,ri){if(sel===ri){if(t!=='00'&&t!=='50')if(ba(d))ok=false;RD.push([t,ok?'OK':'NG',d!=null?ad(d):null]);}}
  function dc(){var result=true;RD=[];DL.forEach(function(rd,ri){var e00=0,e10=0,e11=0,e12=0,e13=0,e20=0,e21=0,e22=0,e23=0,e30=0,e31=0,e40=0,e50=0;if(rd.length>=7){if(rd[0]===91&&rd[1]===41&&rd[2]===62&&rd[3]===30&&rd[4]===48&&rd[5]===54&&rd[6]===29){e00=1;dd('00',true,rd.slice(0,6),ri);}else if(rd[0]===91){var c=-1;rd.some(function(v,i){if(v===29){c=i;return true;}return false;});if(c>0){e00=1;dd('00',false,rd.slice(0,c),ri);}}}else result=false;if(rd[rd.length-1]===35||rd[rd.length-1]===4){e50=1;if(rd[rd.length-4]===29&&rd[rd.length-3]===30&&rd[rd.length-2]===4&&rd[rd.length-1]===35)dd('50',true,rd.slice(rd.length-3,rd.length-1),ri);else if(rd[rd.length-3]===29&&rd[rd.length-2]===30&&rd[rd.length-1]===4)dd('50',true,rd.slice(rd.length-2),ri);else{result=false;var c2=-1;for(var x=rd.length;x>0;x--)if(rd[x]===29){c2=x+1;break;}dd('50',false,rd.slice(c2),ri);}}sg(rd).forEach(function(pd){if(pd[0]===86){e10=1;dd('10',pd.length===5,pd.slice(1),ri);if(pd.length!==5)result=false;}else if(pd[0]===80){e11=1;if(pd.length>10&&pd.length<17){if(!hc(pd,45))dd('11',true,pd.slice(1),ri);else dd('11',false,pd.slice(1),ri);}else{result=false;dd('11',false,pd.slice(1),ri);}}else if(pd[0]===83){e12=1;if(pd.length>0&&pd.length<10)dd('12',true,pd.slice(1),ri);else{result=false;dd('12',false,pd.slice(1),ri);}}else if(pd[0]===69){e13=1;if((pd.length>8&&pd.length<11)||pd.length===1)dd('13',true,pd.slice(1),ri);else{result=false;dd('13',false,pd.slice(1),ri);}}else if(pd[0]===84){if(pd.length>6){e20=1;if(vd(pd.slice(1,7)))dd('20',true,pd.slice(1,7),ri);else{result=false;dd('20',false,pd.slice(1,7),ri);}}if(pd.length>7){e21=1;if(pd.length>10)dd('21',true,pd.slice(7,11),ri);else{result=false;dd('21',false,pd.slice(7),ri);}}if(pd.length>11){e22=1;if(pd[11]===64||pd[11]===65)dd('22',true,pd[11],ri);else{result=false;dd('22',false,pd[11],ri);}}if(pd.length>12){e23=1;dd('23',true,pd.slice(12),ri);}}else if(pd[0]>48&&pd[0]<58){e30=1;if(pd.length>1&&pd.length<42)dd('30',true,pd.slice(2),ri);else{result=false;dd('30',false,pd.slice(2),ri);}}else if(pd[0]===77){e31=1;if(pd.length===1)dd('31',true,pd[1],ri);else if(pd.length===2){if(pd[1]===89||pd[1]===78)dd('31',true,pd[1],ri);else{result=false;dd('31',false,pd[1],ri);}}else{result=false;dd('31',false,pd[1],ri);}}else if(pd[0]===67){e40=1;if(pd.length>0&&pd.length<52)dd('40',true,pd.slice(1),ri);else{result=false;dd('40',false,pd.slice(1),ri);}}});if(!e00){result=false;dd('00',false,fb(rd),ri);}if(!e10){result=false;dd('10',false,null,ri);}if(!e11){result=false;dd('11',false,null,ri);}if(!e12)dd('12',true,null,ri);if(!e20){result=false;dd('20',false,null,ri);}if(!e21){result=false;dd('21',false,null,ri);}if(!e22){result=false;dd('22',false,null,ri);}if(!e23){result=false;dd('23',false,null,ri);}if(!e50){result=false;dd('50',false,lb(rd),ri);}});return result;}
}

var LANG={ko:{appTitle:'HM Barcode Checker',standard:'H/KMC부품 2D 바코드 표준',scan:'스캔',history:'이력',lang:'언어',manual:'수동입력',barcodeContent:'바코드내용',item:'구분',result:'결과',data:'데이터',header:'Header',spec:'사양\n정보',supplier:'업체코드',partNo:'부품번호',seqCode:'서열코드',eoNo:'EO번호',trace:'추적\n정보',prodDate:'생산일자',part4m:'부품4M',aOrAt:'A or @',traceNo:'추적번호\n(7~)',additional:'부가\n정보',special:'특이정보',initial:'초도품구분',etc:'기타',supplierArea:'업체영역',trailer:'Trailer',close:'닫기',histTitle:'바코드 이력',view:'보기',noData:'등록된 데이터가 없습니다',clearAll:'전체삭제',selectLang:'언어 선택',inputTitle:'바코드 입력',analyze:'분석',cancel:'취소',placeholder:'바코드 데이터를 직접 입력하세요...',camCard:'실시간 스캔',galCard:'사진 업로드'},en:{appTitle:'HM Barcode Checker',standard:'H/KMC Part 2D Barcode Standard',scan:'Scan',history:'History',lang:'Language',manual:'Manual',barcodeContent:'Barcode Content',item:'Item',result:'Result',data:'Data',header:'Header',spec:'Spec\nInfo',supplier:'Supplier Code',partNo:'Part Number',seqCode:'Seq Code',eoNo:'EO Number',trace:'Trace-\nability',prodDate:'Prod Date',part4m:'Part 4M',aOrAt:'A or @',traceNo:'Trace No.\n(7~)',additional:'Addi-\ntional',special:'Special Code',initial:'Initial Sample',etc:'ETC',supplierArea:'Supplier Area',trailer:'Trailer',close:'Close',histTitle:'Barcode History',view:'View',noData:'No data registered',clearAll:'Clear All',selectLang:'Select Language',inputTitle:'Barcode Input',analyze:'Analyze',cancel:'Cancel',placeholder:'Enter barcode data manually...',camCard:'Live Scan',galCard:'Upload Photo'}};

var currentLang='ko',analyzer=new DataAnalyzer(),historyList=[],html5QrCode=null;

function showPage(n){document.querySelectorAll('.page').forEach(function(p){p.classList.remove('active');});document.getElementById('page-'+n).classList.add('active');if(n==='history')renderHistory();window.scrollTo(0,0);}

function setLang(lang){
  currentLang=lang;var L=LANG[lang];
  var m={secBarcode:'barcodeContent',secResult:'standard',navLang:'lang',navHist:'history',navScan:'scan',inputTitle:'inputTitle',camCardLabel:'camCard',galCardLabel:'galCard',inputCancel:'cancel',inputAnalyze:'analyze',histPageTitle:'histTitle',histClear:'clearAll',histClose:'close',langPageTitle:'selectLang',langClose:'close',stopScanBtn:'close'};
  for(var id in m) {var el=document.getElementById(id); if(el) el.textContent=L[m[id]];}
  document.getElementById('manualInput').placeholder=L.placeholder;
  document.getElementById('chkKo').style.display=lang==='ko'?'inline':'none';
  document.getElementById('chkEn').style.display=lang==='en'?'inline':'none';
  showPage('main');
}

function processBarcode(data){
  var L=LANG[currentLang];analyzer.setBarcodeData(data);
  document.getElementById('emptyState').style.display='none';
  document.getElementById('barcodeSection').style.display='';
  document.getElementById('fullViewData').innerHTML=analyzer.getFullViewData();
  var tc=analyzer.getCount();
  if(tc>1){
    document.getElementById('tabSection').style.display='';
    var th='';
    for(var i=0;i<tc;i++){
      var lb=i===0?'Assy':'Sub'+String(i).padStart(2,'0');
      th+='<button class="tab-btn'+(i===0?' active':'')+'" onclick="switchTab('+i+')">'+lb+'</button>';
    }
    document.getElementById('tabBar').innerHTML=th;
  }else document.getElementById('tabSection').style.display='none';
  
  var ok=analyzer.getCheckResult(),RD=analyzer.getResultData(),bd=document.getElementById('passBadge');
  bd.style.display='';bd.className='pass-badge '+(ok?'ok':'ng');bd.textContent=ok?'PASS':'FAIL';
  
  renderTable(RD,L); 
  
  var now=new Date(),ds=now.getFullYear()+'-'+String(now.getMonth()+1).padStart(2,'0')+'-'+String(now.getDate()).padStart(2,'0')+' '+String(now.getHours()).padStart(2,'0')+':'+String(now.getMinutes()).padStart(2,'0');
  historyList.unshift({date:ds,barcode:data,okng:ok?'OK':'NG'});
  if(historyList.length>50)historyList=historyList.slice(0,50);
  
  var fl=document.getElementById('flashEffect');fl.style.display='';
  setTimeout(function(){fl.style.display='none';},400);
  showPage('main');
}

function switchTab(idx){
  var L=LANG[currentLang];analyzer.setSelectIndex(idx);
  document.getElementById('fullViewData').innerHTML=analyzer.getFullViewData();
  var ok=analyzer.getCheckResult(),bd=document.getElementById('passBadge');
  bd.className='pass-badge '+(ok?'ok':'ng');bd.textContent=ok?'PASS':'FAIL';
  renderTable(analyzer.getResultData(),L);
  document.querySelectorAll('.tab-btn').forEach(function(b,i){b.className='tab-btn'+(i===idx?' active':'');});
}

function renderTable(RD, L) {
  var f = {}; RD.forEach(function(r) { f[r[0]] = true; });
  function gR(c) {
    var rw = null; RD.forEach(function(r) { if (r[0] === c) rw = r; });
    return rw ? { r: rw[1], d: rw[2] } : { r: null, d: null };
  }
  function bH(r) {
    if (!r) return '-';
    if (r === 'OK') return '<span class="txt-ok">OK</span>';
    if (r === 'NG') return '<span class="txt-ng">NG</span>';
    return r;
  }
  function dH(d) { return d ? '<span class="td-data">' + d + '</span>' : ''; }

  var h = '<thead><tr><th colspan="2">' + L.item + '</th><th style="width:50px;">' + L.result + '</th><th>' + L.data + '</th></tr></thead><tbody>';

  var rh = gR('00');
  h += '<tr><td colspan="2" class="td-head">' + L.header + '</td><td class="td-center">' + (rh.r ? bH(rh.r) : '-') + '</td><td>' + dH(rh.d) + '</td></tr>';

  h += '<tr><td rowspan="4" class="td-head">' + L.spec + '</td><td class="td-head">' + L.supplier + '</td><td class="td-center">' + (gR('10').r ? bH(gR('10').r) : '-') + '</td><td>' + dH(gR('10').d) + '</td></tr>';
  h += '<tr><td class="td-head">' + L.partNo + '</td><td class="td-center">' + (gR('11').r ? bH(gR('11').r) : '-') + '</td><td>' + dH(gR('11').d) + '</td></tr>';
  h += '<tr><td class="td-head">' + L.seqCode + '</td><td class="td-center">' + (gR('12').r ? bH(gR('12').r) : '-') + '</td><td>' + dH(gR('12').d) + '</td></tr>';
  h += '<tr><td class="td-head">' + L.eoNo + '</td><td class="td-center">' + (gR('13').r ? bH(gR('13').r) : '-') + '</td><td>' + dH(gR('13').d) + '</td></tr>';

  h += '<tr><td rowspan="4" class="td-head">' + L.trace + '</td><td class="td-head">' + L.prodDate + '</td><td class="td-center">' + (gR('20').r ? bH(gR('20').r) : '-') + '</td><td>' + dH(gR('20').d) + '</td></tr>';
  h += '<tr><td class="td-head">' + L.part4m + '</td><td class="td-center">' + (gR('21').r ? bH(gR('21').r) : '-') + '</td><td>' + dH(gR('21').d) + '</td></tr>';
  h += '<tr><td class="td-head">' + L.aOrAt + '</td><td class="td-center">' + (gR('22').r ? bH(gR('22').r) : '-') + '</td><td>' + dH(gR('22').d) + '</td></tr>';
  h += '<tr><td class="td-head">' + L.traceNo + '</td><td class="td-center">' + (gR('23').r ? bH(gR('23').r) : '-') + '</td><td>' + dH(gR('23').d) + '</td></tr>';

  var r30 = gR('30'), r31 = gR('31');
  if (f['30'] && f['31']) {
    h += '<tr><td rowspan="2" class="td-head">' + L.additional + '</td><td class="td-head">' + L.special + '</td><td class="td-center">' + (r30.r ? bH(r30.r) : '-') + '</td><td>' + dH(r30.d) + '</td></tr>';
    h += '<tr><td class="td-head">' + L.initial + '</td><td class="td-center">' + (r31.r ? bH(r31.r) : '-') + '</td><td>' + dH(r31.d) + '</td></tr>';
  } else if (f['30']) {
    h += '<tr><td class="td-head">' + L.additional + '</td><td class="td-head">' + L.special + '</td><td class="td-center">' + (r30.r ? bH(r30.r) : '-') + '</td><td>' + dH(r30.d) + '</td></tr>';
  } else {
    h += '<tr><td class="td-head">' + L.additional + '</td><td class="td-head">' + L.initial + '</td><td class="td-center">' + (r31.r ? bH(r31.r) : '-') + '</td><td>' + dH(r31.d) + '</td></tr>';
  }

  var r40 = gR('40');
  h += '<tr><td class="td-head">' + L.etc + '</td><td class="td-head">' + L.supplierArea + '</td><td class="td-center">' + (r40.r ? bH(r40.r) : '-') + '</td><td>' + dH(r40.d) + '</td></tr>';

  var rt = gR('50');
  h += '<tr><td colspan="2" class="td-head">' + L.trailer + '</td><td class="td-center">' + (rt.r ? bH(rt.r) : '-') + '</td><td>' + dH(rt.d) + '</td></tr>';

  h += '</tbody>';
  document.getElementById('resultTable').innerHTML = h;
  document.getElementById('resultSection').style.display = '';
}

function analyzeManual(){
  var v=document.getElementById('manualInput').value.trim();
  if(v){document.getElementById('manualInput').value='';processBarcode(v);}
}

function renderHistory(){
  var el=document.getElementById('historyContent');
  if(historyList.length===0){el.innerHTML='<div style="text-align:center;padding:40px 0;color:var(--text-sub);font-weight:600;">데이터가 없습니다.</div>';return;}
  var h='';
  historyList.forEach(function(it,i){
    var col=it.okng==='OK'?'#43a047':'#e53935';
    h+='<div class="hist-item"><div style="flex:1;overflow:hidden"><div class="date">'+it.date+'</div><div class="code">'+it.barcode+'</div></div><div style="font-weight:800;color:'+col+';margin:0 15px">'+it.okng+'</div><button onclick="processBarcode(historyList['+i+'].barcode)" style="padding:8px 16px;background:var(--primary);color:#fff;border:none;border-radius:8px;font-weight:600;cursor:pointer;">보기</button></div>';
  });
  el.innerHTML=h;
}

function clearHistory(){
  if(confirm('전체 이력을 삭제하시겠습니까?')){historyList=[];renderHistory();}
}

function startScan(){
  showPage('main');
  document.getElementById('scannerOverlay').style.display='flex';
  if (!html5QrCode) html5QrCode = new Html5Qrcode("qr-reader");
  html5QrCode.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: { width: 250, height: 250 } },
    function(dt) { closeScanner(); processBarcode(dt); },
    function(err) {}
  ).catch(function(e) { alert("카메라 접근에 실패했습니다."); closeScanner(); });
}

function closeScanner(){
  if(html5QrCode && html5QrCode.isScanning) html5QrCode.stop().then(function(){html5QrCode.clear();});
  document.getElementById('scannerOverlay').style.display='none';
}

var galleryInput=document.getElementById('galleryInput');
function openGallery(){galleryInput.value='';galleryInput.click();}
galleryInput.addEventListener('change',function(e){
  var file=e.target.files[0];if(!file)return;
  if (!html5QrCode) html5QrCode = new Html5Qrcode("qr-reader"); 
  html5QrCode.scanFile(file, true).then(function(dt) {
    processBarcode(dt);
  }).catch(function(err) {
    alert("바코드를 인식할 수 없습니다.");
  });
});

setLang('ko');
</script>
</body>
</html>
