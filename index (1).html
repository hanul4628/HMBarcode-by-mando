<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="HM Barcode">
<meta name="theme-color" content="#15548f">
<title>HM Barcode Checker</title>
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<style>
:root{--safe-b:env(safe-area-inset-bottom,0px)}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{font-family:-apple-system,BlinkMacSystemFont,'Apple SD Gothic Neo','Noto Sans KR',sans-serif;background:#e9ecef;color:#222;min-height:100vh;min-height:100dvh;-webkit-text-size-adjust:100%;overflow-x:hidden}
.page{display:none;min-height:100vh;min-height:100dvh;padding-bottom:calc(80px + var(--safe-b))}.page.active{display:block}

/* ì˜ˆì‹œ ì‚¬ì§„ í…Œë§ˆ ê¸°ë°˜ íŒ¨ë„ ë””ìì¸ */
.panel { background: #fff; border: 1px solid #b0b5ba; border-radius: 8px; margin-bottom: 16px; overflow: hidden; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
.panel-header { background: #15548f; color: #fff; padding: 12px 14px; font-size: 16px; font-weight: bold; display: flex; align-items: center; gap: 8px; }
.panel-header svg { width: 18px; height: 18px; fill: none; stroke: currentColor; stroke-width: 2; }
.panel-body { padding: 0; background: #f2f2f2; }
.panel-body.content-box { padding: 12px; font-family: 'SF Mono', Menlo, monospace; font-size: 13px; line-height: 1.8; word-break: break-all; white-space: pre-line; border-top: 1px solid #b0b5ba; }

/* ë°”ì½”ë“œ ë‚´ìš© í…ìŠ¤íŠ¸ í•˜ì´ë¼ì´íŠ¸ ë° ì œì–´ë¬¸ì */
.highlight-yellow { background: #ffeb3b; font-weight: bold; }
.gs{color:#d32f2f;font-weight:bold}.rs{color:#388e3c;font-weight:bold}.eot{color:#1976d2;font-weight:bold}

/* í‘œ í˜•íƒœì˜ ê²°ê³¼ í…Œì´ë¸” (rowspan ëŒ€ì‘) */
.result-table { width: 100%; border-collapse: collapse; font-size: 14px; background: #fff; }
.result-table th, .result-table td { border: 1px solid #c4c4c4; padding: 10px 8px; vertical-align: middle; }
.result-table thead th { background: #f2f2f2; color: #333; font-weight: bold; text-align: center; }
.result-table .td-head { background: #f8f8f8; text-align: center; font-weight: bold; color: #333; }
.result-table .td-center { text-align: center; }
.result-table .td-data { font-family: 'SF Mono', Menlo, monospace; font-weight: bold; }
.txt-ok { color: #1976d2; font-weight: bold; }
.txt-ng { color: #d32f2f; font-weight: bold; }

/* í•˜ë‹¨ ë²„íŠ¼ ë°” (ì˜ˆì‹œ ì‚¬ì§„ ìŠ¤íƒ€ì¼) */
.bottom-bar { position: fixed; bottom: 0; left: 0; right: 0; z-index: 40; background: #dae1e7; border-top: 2px solid #6ab4e4; padding: 12px; padding-bottom: calc(12px + var(--safe-b)); display: flex; gap: 10px; }
.bottom-btn { flex: 1; padding: 14px 0; background: #006eb8; color: #fff; font-size: 16px; font-weight: bold; border-radius: 4px; border: none; cursor: pointer; text-align: center; box-shadow: inset 0 -2px 0 rgba(0,0,0,0.1); }
.bottom-btn:active { background: #005691; transform: translateY(1px); box-shadow: none; }

/* ìƒíƒœ ë±ƒì§€ (PASS/FAIL) */
.pass-badge { float: right; padding: 4px 10px; border-radius: 4px; font-size: 12px; color: #fff; }
.pass-badge.ok { background: #2e7d32; }
.pass-badge.ng { background: #c62828; }

/* íƒ­ ë²„íŠ¼, ì…ë ¥ì°½ ë“± ë¶€ê°€ UI ë³´ì¡´ */
.content{padding:16px 16px 0}
.empty-state{text-align:center;padding:60px 20px}.empty-state .icon{font-size:56px;margin-bottom:16px}.empty-state .text{color:#666;font-size:14px;line-height:1.6;white-space:pre-line}
.text-input{width:100%;height:120px;border:1px solid #ccc;border-radius:4px;padding:12px;font-size:14px;resize:none;outline:none}
.tab-bar{display:flex;gap:8px;overflow-x:auto;padding:0 0 12px}
.tab-btn{padding:8px 16px;border:1px solid #ccc;background:#fff;border-radius:4px;font-weight:bold}
.tab-btn.active{background:#15548f;color:#fff;border-color:#15548f}

/* ìŠ¤ìºë„ˆ UI */
.scanner-overlay{position:fixed;inset:0;z-index:100;background:#000;display:flex;flex-direction:column}
#qr-reader{position:absolute;inset:0;width:100%;height:100%}
#qr-reader video{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
.scan-ui{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none}
.scan-dim{position:absolute;inset:0;background:linear-gradient(to bottom,rgba(0,0,0,0.6) 0%,rgba(0,0,0,0.25) 35%,rgba(0,0,0,0.25) 65%,rgba(0,0,0,0.6) 100%)}
.scan-frame{position:relative;width:250px;height:250px;border:2px solid rgba(255,255,255,0.4)}
.scan-line{position:absolute;left:0;right:0;height:2px;top:50%;background:#ff0000;box-shadow:0 0 4px #ff0000;animation:scanMove 2s ease-in-out infinite}
@keyframes scanMove{0%,100%{top:5%}50%{top:95%}}
.scan-bottom{position:absolute;bottom:0;left:0;right:0;background:rgba(0,0,0,0.8);padding:20px;z-index:10}
.scan-stop{width:100%;padding:14px;background:#333;color:#fff;border:none;border-radius:4px;font-size:16px;font-weight:bold}

.flash{position:fixed;inset:0;z-index:200;background:rgba(255,255,255,0.8);pointer-events:none;animation:fadeOut 0.4s ease-out forwards}
@keyframes fadeOut{from{opacity:1}to{opacity:0}}
#galleryInput{display:none}
.action-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px}
.action-card{padding:20px;background:#fff;border:1px solid #ccc;border-radius:8px;text-align:center;font-weight:bold;cursor:pointer}
.hist-item{background:#fff;border:1px solid #ccc;padding:12px;margin-bottom:8px;border-radius:4px;display:flex;justify-content:space-between;align-items:center}
</style>
</head>
<body>
<div id="page-main" class="page active">
  <div class="content">
    <div id="emptyState" class="empty-state"><div class="icon">ğŸ“·</div><div class="text" id="emptyText">ì•„ë˜ ìŠ¤ìº” ë²„íŠ¼ì„ ëˆŒëŸ¬<br>ë°”ì½”ë“œë¥¼ ë¶„ì„í•˜ì„¸ìš”</div></div>
    
    <div id="tabSection" style="display:none"><div class="tab-bar" id="tabBar"></div></div>

    <div id="barcodeSection" class="panel" style="display:none">
      <div class="panel-header">
        <svg viewBox="0 0 24 24"><path d="M4 6h16M4 12h16M4 18h16"></path></svg>
        <span id="secBarcode">ë°”ì½”ë“œë‚´ìš©</span>
        <div id="passBadge" class="pass-badge" style="display:none"></div>
      </div>
      <div class="panel-body content-box" id="fullViewData"></div>
    </div>

    <div id="resultSection" class="panel" style="display:none">
      <div class="panel-header">
        <svg viewBox="0 0 24 24"><path d="M4 6h16M4 12h16M4 18h16"></path></svg>
        <span id="secResult">H/KMCë¶€í’ˆ 2D ë°”ì½”ë“œ í‘œì¤€</span>
      </div>
      <div class="panel-body">
        <table class="result-table" id="resultTable"></table>
      </div>
    </div>
  </div>

  <div class="bottom-bar">
    <button class="bottom-btn" onclick="showPage('language')" id="navLang">ì–¸ì–´</button>
    <button class="bottom-btn" onclick="showPage('history')" id="navHist">ì´ë ¥</button>
    <button class="bottom-btn" onclick="startScan()" id="navScan">ìŠ¤ìº”</button>
  </div>
</div>

<div id="page-input" class="page">
  <div class="content">
    <div class="panel">
      <div class="panel-header"><span id="inputTitle">ë°”ì½”ë“œ ì…ë ¥</span></div>
      <div class="panel-body" style="padding:16px; background:#fff;">
        <div class="action-grid">
          <button class="action-card" onclick="startScan()" id="camCardLabel">ì‹¤ì‹œê°„ ìŠ¤ìº”</button>
          <button class="action-card" onclick="openGallery()" id="galCardLabel">ì‚¬ì§„ ì—…ë¡œë“œ</button>
        </div>
        <input type="file" id="galleryInput" accept="image/*">
        <textarea class="text-input" id="manualInput" placeholder="ë°”ì½”ë“œ ë°ì´í„°ë¥¼ ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
        <div style="margin-top:10px;text-align:right">
          <button onclick="analyzeManual()" style="padding:10px 20px;background:#006eb8;color:#fff;border:none;border-radius:4px;font-weight:bold" id="inputAnalyze">ë¶„ì„</button>
        </div>
      </div>
    </div>
  </div>
  <div class="bottom-bar">
    <button class="bottom-btn" onclick="showPage('main')" id="inputCancel">ì·¨ì†Œ</button>
  </div>
</div>

<div id="page-history" class="page">
  <div class="content">
    <div class="panel">
      <div class="panel-header"><span id="histPageTitle">ë°”ì½”ë“œ ì´ë ¥</span></div>
      <div class="panel-body" style="padding:12px; background:#fff;" id="historyContent"></div>
    </div>
  </div>
  <div class="bottom-bar">
    <button class="bottom-btn" style="background:#d32f2f" onclick="clearHistory()" id="histClear">ì „ì²´ì‚­ì œ</button>
    <button class="bottom-btn" onclick="showPage('main')" id="histClose">ë‹«ê¸°</button>
  </div>
</div>

<div id="page-language" class="page">
  <div class="content">
    <div class="panel">
      <div class="panel-header"><span id="langPageTitle">ì–¸ì–´ ì„ íƒ</span></div>
      <div class="panel-body" style="background:#fff;">
        <div style="padding:16px;border-bottom:1px solid #eee;cursor:pointer" onclick="setLang('ko')">í•œêµ­ì–´ <span id="chkKo" style="float:right;display:none;color:#006eb8;font-weight:bold">âœ“</span></div>
        <div style="padding:16px;cursor:pointer" onclick="setLang('en')">English <span id="chkEn" style="float:right;display:none;color:#006eb8;font-weight:bold">âœ“</span></div>
      </div>
    </div>
  </div>
  <div class="bottom-bar">
    <button class="bottom-btn" onclick="showPage('main')" id="langClose">ë‹«ê¸°</button>
  </div>
</div>

<div id="scannerOverlay" class="scanner-overlay" style="display:none">
  <div id="qr-reader"></div>
  <div class="scan-ui"><div class="scan-dim"></div><div class="scan-frame"><div class="scan-line"></div></div></div>
  <div class="scan-bottom"><button class="scan-stop" onclick="closeScanner()" id="stopScanBtn">ìŠ¤ìº” ì¤‘ì§€</button></div>
</div>

<div id="flashEffect" class="flash" style="display:none"></div>

<script>
function DataAnalyzer(){
  var D=[],DL=[],RD=[],cnt=0,sel=0;
  this.setBarcodeData=function(s){D=[];DL=[];RD=[];cnt=0;sel=0;af(s);sd();};
  this.setSelectIndex=function(i){sel=i;};this.getSelectedIndex=function(){return sel;};
  
  // ì „ì²´ ë¬¸ìì—´ì— ë…¸ë€ìƒ‰ ë°°ê²½ í•˜ì´ë¼ì´íŠ¸ë¥¼ ì ìš© (ì‚¬ì§„ í…Œë§ˆ ë°˜ì˜)
  this.getFullViewData=function(){
    var r='';
    DL.forEach(function(row,i){
      if(i===sel) r+='<span class="highlight-yellow">';
      row.forEach(function(v){r+=cc(v);});
      if(i===sel) r+='</span>';
    });
    return r;
  };
  
  this.getCount=function(){return cnt;};
  this.getCheckResult=function(){return dc();};this.getResultData=function(){return RD;};
  function af(s){D=[];for(var i=0;i<s.length;i++)if(s.charCodeAt(i)!==32)D.push(s.charCodeAt(i));}
  function sd(){var r=[];D.forEach(function(v){r.push(v);if(v===35){DL.push(r);r=[];cnt++;}});if(r.length>0){DL.push(r);cnt++;}}
  function lp(n,w){n=n+'';return n.length>=w?n:new Array(w-n.length+1).join('0')+n;}
  function cc(s){if(s===29)return'<span class="gs"><sup>G</sup><sub>S</sub></span>';if(s===30)return'<span class="rs"><sup>R</sup><sub>S</sub></span>';if(s===4)return'<span class="eot"><sup>E</sup>O<sub>T</sub></span>';if(s===35)return'#<br>';if((s>=0&&s<=32)||s===127)return'&lt;0x'+lp(s.toString(16).toUpperCase(),2)+'&gt;';return String.fromCharCode(s);}
  function ad(a){var r='';if(typeof a==='number')return cc(a);if(a)a.forEach(function(v){r+=cc(v);});return r;}
  function hc(a,c){return a.some(function(v){return v===c;});}
  function vd(a){var s='';a.forEach(function(v){s+=String.fromCharCode(v);});if(!/[0-9]{2}[0-1]{1}[0-9]{1}[0-9]{2}/.test(s))return false;var ld=[31,28,31,30,31,30,31,31,30,31,30,31],y=Number('20'+s.substr(0,2)),m=Number(s.substr(2,2)),d=Number(s.substr(4,2));if(m>12||m===0||d===0)return false;if(y%4===0&&(y%100!==0||y%400===0)&&m===2)return d<=29;return d<=ld[m-1];}
  function ba(a){if(!a||(Array.isArray(a)&&a.length===0))return false;var c=function(v){return v<47||(v>57&&v<65)||(v>90&&v<97)||v>122;};if(typeof a==='number')return c(a);for(var i=0;i<a.length;i++)if(c(a[i]))return true;return false;}
  function sg(a){var r=[],row=[];a.forEach(function(v){if(v===29){r.push(row.slice(0));row=[];}else row.push(v);});return r;}
  function fb(a){var c=-1;a.some(function(v,i){if(v===29){c=i;return true;}return false;});return a.slice(0,c);}
  function lb(a){var c=-1;for(var x=a.length;x>0;x--)if(a[x]===29){c=x+1;break;}return a.slice(c);}
  function dd(t,ok,d,ri){if(sel===ri){if(t!=='00'&&t!=='50')if(ba(d))ok=false;RD.push([t,ok?'OK':'NG',d!=null?ad(d):null]);}}
  function dc(){var result=true;RD=[];DL.forEach(function(rd,ri){var e00=0,e10=0,e11=0,e12=0,e13=0,e20=0,e21=0,e22=0,e23=0,e30=0,e31=0,e40=0,e50=0;if(rd.length>=7){if(rd[0]===91&&rd[1]===41&&rd[2]===62&&rd[3]===30&&rd[4]===48&&rd[5]===54&&rd[6]===29){e00=1;dd('00',true,rd.slice(0,6),ri);}else if(rd[0]===91){var c=-1;rd.some(function(v,i){if(v===29){c=i;return true;}return false;});if(c>0){e00=1;dd('00',false,rd.slice(0,c),ri);}}}else result=false;if(rd[rd.length-1]===35||rd[rd.length-1]===4){e50=1;if(rd[rd.length-4]===29&&rd[rd.length-3]===30&&rd[rd.length-2]===4&&rd[rd.length-1]===35)dd('50',true,rd.slice(rd.length-3,rd.length-1),ri);else if(rd[rd.length-3]===29&&rd[rd.length-2]===30&&rd[rd.length-1]===4)dd('50',true,rd.slice(rd.length-2),ri);else{result=false;var c2=-1;for(var x=rd.length;x>0;x--)if(rd[x]===29){c2=x+1;break;}dd('50',false,rd.slice(c2),ri);}}sg(rd).forEach(function(pd){if(pd[0]===86){e10=1;dd('10',pd.length===5,pd.slice(1),ri);if(pd.length!==5)result=false;}else if(pd[0]===80){e11=1;if(pd.length>10&&pd.length<17){if(!hc(pd,45))dd('11',true,pd.slice(1),ri);else dd('11',false,pd.slice(1),ri);}else{result=false;dd('11',false,pd.slice(1),ri);}}else if(pd[0]===83){e12=1;if(pd.length>0&&pd.length<10)dd('12',true,pd.slice(1),ri);else{result=false;dd('12',false,pd.slice(1),ri);}}else if(pd[0]===69){e13=1;if((pd.length>8&&pd.length<11)||pd.length===1)dd('13',true,pd.slice(1),ri);else{result=false;dd('13',false,pd.slice(1),ri);}}else if(pd[0]===84){if(pd.length>6){e20=1;if(vd(pd.slice(1,7)))dd('20',true,pd.slice(1,7),ri);else{result=false;dd('20',false,pd.slice(1,7),ri);}}if(pd.length>7){e21=1;if(pd.length>10)dd('21',true,pd.slice(7,11),ri);else{result=false;dd('21',false,pd.slice(7),ri);}}if(pd.length>11){e22=1;if(pd[11]===64||pd[11]===65)dd('22',true,pd[11],ri);else{result=false;dd('22',false,pd[11],ri);}}if(pd.length>12){e23=1;dd('23',true,pd.slice(12),ri);}}else if(pd[0]>48&&pd[0]<58){e30=1;if(pd.length>1&&pd.length<42)dd('30',true,pd.slice(2),ri);else{result=false;dd('30',false,pd.slice(2),ri);}}else if(pd[0]===77){e31=1;if(pd.length===1)dd('31',true,pd[1],ri);else if(pd.length===2){if(pd[1]===89||pd[1]===78)dd('31',true,pd[1],ri);else{result=false;dd('31',false,pd[1],ri);}}else{result=false;dd('31',false,pd[1],ri);}}else if(pd[0]===67){e40=1;if(pd.length>0&&pd.length<52)dd('40',true,pd.slice(1),ri);else{result=false;dd('40',false,pd.slice(1),ri);}}});if(!e00){result=false;dd('00',false,fb(rd),ri);}if(!e10){result=false;dd('10',false,null,ri);}if(!e11){result=false;dd('11',false,null,ri);}if(!e12)dd('12',true,null,ri);if(!e20){result=false;dd('20',false,null,ri);}if(!e21){result=false;dd('21',false,null,ri);}if(!e22){result=false;dd('22',false,null,ri);}if(!e23){result=false;dd('23',false,null,ri);}if(!e50){result=false;dd('50',false,lb(rd),ri);}});return result;}
}

var LANG={ko:{appTitle:'HM Barcode Checker',standard:'H/KMCë¶€í’ˆ 2D ë°”ì½”ë“œ í‘œì¤€',scan:'ìŠ¤ìº”',history:'ì´ë ¥',lang:'ì–¸ì–´',manual:'ìˆ˜ë™ì…ë ¥',barcodeContent:'ë°”ì½”ë“œë‚´ìš©',item:'êµ¬ë¶„',result:'ê²°ê³¼',data:'ë°ì´í„°',header:'Header',spec:'ì‚¬ì–‘\nì •ë³´',supplier:'ì—…ì²´ì½”ë“œ',partNo:'ë¶€í’ˆë²ˆí˜¸',seqCode:'ì„œì—´ì½”ë“œ',eoNo:'EOë²ˆí˜¸',trace:'ì¶”ì \nì •ë³´',prodDate:'ìƒì‚°ì¼ì',part4m:'ë¶€í’ˆ4M',aOrAt:'A or @',traceNo:'ì¶”ì ë²ˆí˜¸\n(7~)',additional:'ë¶€ê°€\nì •ë³´',special:'íŠ¹ì´ì •ë³´',initial:'ì´ˆë„í’ˆêµ¬ë¶„',etc:'ê¸°íƒ€',supplierArea:'ì—…ì²´ì˜ì—­',trailer:'Trailer',close:'ë‹«ê¸°',histTitle:'ë°”ì½”ë“œ ì´ë ¥',view:'ë³´ê¸°',noData:'ë“±ë¡ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤',clearAll:'ì „ì²´ì‚­ì œ',selectLang:'ì–¸ì–´ ì„ íƒ',inputTitle:'ë°”ì½”ë“œ ì…ë ¥',analyze:'ë¶„ì„',cancel:'ì·¨ì†Œ',placeholder:'ë°”ì½”ë“œ ë°ì´í„°ë¥¼ ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”...',camCard:'ì‹¤ì‹œê°„ ìŠ¤ìº”',galCard:'ì‚¬ì§„ ì—…ë¡œë“œ'},en:{appTitle:'HM Barcode Checker',standard:'H/KMC Part 2D Barcode Standard',scan:'Scan',history:'History',lang:'Language',manual:'Manual',barcodeContent:'Barcode Content',item:'Item',result:'Result',data:'Data',header:'Header',spec:'Spec\nInfo',supplier:'Supplier Code',partNo:'Part Number',seqCode:'Seq Code',eoNo:'EO Number',trace:'Trace-\nability',prodDate:'Prod Date',part4m:'Part 4M',aOrAt:'A or @',traceNo:'Trace No.\n(7~)',additional:'Addi-\ntional',special:'Special Code',initial:'Initial Sample',etc:'ETC',supplierArea:'Supplier Area',trailer:'Trailer',close:'Close',histTitle:'Barcode History',view:'View',noData:'No data registered',clearAll:'Clear All',selectLang:'Select Language',inputTitle:'Barcode Input',analyze:'Analyze',cancel:'Cancel',placeholder:'Enter barcode data manually...',camCard:'Live Scan',galCard:'Upload Photo'}};

var currentLang='ko',analyzer=new DataAnalyzer(),historyList=[],html5QrCode=null;

function showPage(n){document.querySelectorAll('.page').forEach(function(p){p.classList.remove('active');});document.getElementById('page-'+n).classList.add('active');if(n==='history')renderHistory();window.scrollTo(0,0);}

function setLang(lang){
  currentLang=lang;var L=LANG[lang];
  var m={secBarcode:'barcodeContent',secResult:'standard',navLang:'lang',navHist:'history',navScan:'scan',inputTitle:'inputTitle',camCardLabel:'camCard',galCardLabel:'galCard',inputCancel:'cancel',inputAnalyze:'analyze',histPageTitle:'histTitle',histClear:'clearAll',histClose:'close',langPageTitle:'selectLang',langClose:'close',stopScanBtn:'close'};
  for(var id in m) {var el=document.getElementById(id); if(el) el.textContent=L[m[id]];}
  document.getElementById('manualInput').placeholder=L.placeholder;
  document.getElementById('chkKo').style.display=lang==='ko'?'inline':'none';
  document.getElementById('chkEn').style.display=lang==='en'?'inline':'none';
  showPage('main');
}

function processBarcode(data){
  var L=LANG[currentLang];analyzer.setBarcodeData(data);
  document.getElementById('emptyState').style.display='none';
  document.getElementById('barcodeSection').style.display='';
  document.getElementById('fullViewData').innerHTML=analyzer.getFullViewData();
  var tc=analyzer.getCount();
  if(tc>1){
    document.getElementById('tabSection').style.display='';
    var th='';
    for(var i=0;i<tc;i++){
      var lb=i===0?'Assy':'Sub'+String(i).padStart(2,'0');
      th+='<button class="tab-btn'+(i===0?' active':'')+'" onclick="switchTab('+i+')">'+lb+'</button>';
    }
    document.getElementById('tabBar').innerHTML=th;
  }else document.getElementById('tabSection').style.display='none';
  
  var ok=analyzer.getCheckResult(),RD=analyzer.getResultData(),bd=document.getElementById('passBadge');
  bd.style.display='';bd.className='pass-badge '+(ok?'ok':'ng');bd.textContent=ok?'PASS':'FAIL';
  
  renderTable(RD,L); // ìƒˆë¡­ê²Œ ì‘ì„±ëœ í…Œì´ë¸” ë Œë”ë§ í•¨ìˆ˜ í˜¸ì¶œ
  
  var now=new Date(),ds=now.getFullYear()+'-'+String(now.getMonth()+1).padStart(2,'0')+'-'+String(now.getDate()).padStart(2,'0')+' '+String(now.getHours()).padStart(2,'0')+':'+String(now.getMinutes()).padStart(2,'0');
  historyList.unshift({date:ds,barcode:data,okng:ok?'OK':'NG'});
  if(historyList.length>50)historyList=historyList.slice(0,50);
  
  var fl=document.getElementById('flashEffect');fl.style.display='';
  setTimeout(function(){fl.style.display='none';},400);
  showPage('main');
}

function switchTab(idx){
  var L=LANG[currentLang];analyzer.setSelectIndex(idx);
  document.getElementById('fullViewData').innerHTML=analyzer.getFullViewData();
  var ok=analyzer.getCheckResult(),bd=document.getElementById('passBadge');
  bd.className='pass-badge '+(ok?'ok':'ng');bd.textContent=ok?'PASS':'FAIL';
  renderTable(analyzer.getResultData(),L);
  document.querySelectorAll('.tab-btn').forEach(function(b,i){b.className='tab-btn'+(i===idx?' active':'');});
}

// ì˜ˆì‹œ ì‚¬ì§„ êµ¬ì¡°ì™€ ë™ì¼í•˜ê²Œ í…Œì´ë¸”ì„ ê·¸ë ¤ì£¼ëŠ” í•µì‹¬ í•¨ìˆ˜
function renderTable(RD, L) {
  var f = {}; RD.forEach(function(r) { f[r[0]] = true; });
  function gR(c) {
    var rw = null; RD.forEach(function(r) { if (r[0] === c) rw = r; });
    return rw ? { r: rw[1], d: rw[2] } : { r: null, d: null };
  }
  function bH(r) {
    if (!r) return '-';
    if (r === 'OK') return '<span class="txt-ok">OK</span>';
    if (r === 'NG') return '<span class="txt-ng">NG</span>';
    return r;
  }
  function dH(d) { return d ? '<span class="td-data">' + d + '</span>' : ''; }

  var h = '<thead><tr><th colspan="2">' + L.item + '</th><th style="width:50px;">' + L.result + '</th><th>' + L.data + '</th></tr></thead><tbody>';

  // Header (00)
  var rh = gR('00');
  h += '<tr><td colspan="2" class="td-head">' + L.header + '</td><td class="td-center">' + (rh.r ? bH(rh.r) : '-') + '</td><td>' + dH(rh.d) + '</td></tr>';

  // ì‚¬ì–‘ì •ë³´ (span 4) : 10, 11, 12, 13
  h += '<tr><td rowspan="4" class="td-head">' + L.spec + '</td><td class="td-head">' + L.supplier + '</td><td class="td-center">' + (gR('10').r ? bH(gR('10').r) : '-') + '</td><td>' + dH(gR('10').d) + '</td></tr>';
  h += '<tr><td class="td-head">' + L.partNo + '</td><td class="td-center">' + (gR('11').r ? bH(gR('11').r) : '-') + '</td><td>' + dH(gR('11').d) + '</td></tr>';
  h += '<tr><td class="td-head">' + L.seqCode + '</td><td class="td-center">' + (gR('12').r ? bH(gR('12').r) : '-') + '</td><td>' + dH(gR('12').d) + '</td></tr>';
  h += '<tr><td class="td-head">' + L.eoNo + '</td><td class="td-center">' + (gR('13').r ? bH(gR('13').r) : '-') + '</td><td>' + dH(gR('13').d) + '</td></tr>';

  // ì¶”ì ì •ë³´ (span 4) : 20, 21, 22, 23
  h += '<tr><td rowspan="4" class="td-head">' + L.trace + '</td><td class="td-head">' + L.prodDate + '</td><td class="td-center">' + (gR('20').r ? bH(gR('20').r) : '-') + '</td><td>' + dH(gR('20').d) + '</td></tr>';
  h += '<tr><td class="td-head">' + L.part4m + '</td><td class="td-center">' + (gR('21').r ? bH(gR('21').r) : '-') + '</td><td>' + dH(gR('21').d) + '</td></tr>';
  h += '<tr><td class="td-head">' + L.aOrAt + '</td><td class="td-center">' + (gR('22').r ? bH(gR('22').r) : '-') + '</td><td>' + dH(gR('22').d) + '</td></tr>';
  h += '<tr><td class="td-head">' + L.traceNo + '</td><td class="td-center">' + (gR('23').r ? bH(gR('23').r) : '-') + '</td><td>' + dH(gR('23').d) + '</td></tr>';

  // ë¶€ê°€ì •ë³´ (ë™ì  span: 30, 31 ì‚¬ì§„ ê¸°ì¤€)
  var r30 = gR('30'), r31 = gR('31');
  if (f['30'] && f['31']) {
    h += '<tr><td rowspan="2" class="td-head">' + L.additional + '</td><td class="td-head">' + L.special + '</td><td class="td-center">' + (r30.r ? bH(r30.r) : '-') + '</td><td>' + dH(r30.d) + '</td></tr>';
    h += '<tr><td class="td-head">' + L.initial + '</td><td class="td-center">' + (r31.r ? bH(r31.r) : '-') + '</td><td>' + dH(r31.d) + '</td></tr>';
  } else if (f['30']) {
    h += '<tr><td class="td-head">' + L.additional + '</td><td class="td-head">' + L.special + '</td><td class="td-center">' + (r30.r ? bH(r30.r) : '-') + '</td><td>' + dH(r30.d) + '</td></tr>';
  } else {
    // 30ì´ ì—†ê³  31ë§Œ ìˆê±°ë‚˜, ë‘˜ ë‹¤ ì—†ì–´ë„ ê¸°ë³¸ í‘œê²©ì„ ìœ ì§€í•˜ê¸° ìœ„í•´ 31(ì´ˆë„í’ˆêµ¬ë¶„) í‘œì‹œ
    h += '<tr><td class="td-head">' + L.additional + '</td><td class="td-head">' + L.initial + '</td><td class="td-center">' + (r31.r ? bH(r31.r) : '-') + '</td><td>' + dH(r31.d) + '</td></tr>';
  }

  // ê¸°íƒ€ (40)
  var r40 = gR('40');
  h += '<tr><td class="td-head">' + L.etc + '</td><td class="td-head">' + L.supplierArea + '</td><td class="td-center">' + (r40.r ? bH(r40.r) : '-') + '</td><td>' + dH(r40.d) + '</td></tr>';

  // Trailer (50)
  var rt = gR('50');
  h += '<tr><td colspan="2" class="td-head">' + L.trailer + '</td><td class="td-center">' + (rt.r ? bH(rt.r) : '-') + '</td><td>' + dH(rt.d) + '</td></tr>';

  h += '</tbody>';
  document.getElementById('resultTable').innerHTML = h;
  document.getElementById('resultSection').style.display = '';
}

function analyzeManual(){
  var v=document.getElementById('manualInput').value.trim();
  if(v){document.getElementById('manualInput').value='';processBarcode(v);}
}

function renderHistory(){
  var el=document.getElementById('historyContent');
  if(historyList.length===0){el.innerHTML='<div style="text-align:center;padding:30px 0;color:#999">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';return;}
  var h='';
  historyList.forEach(function(it,i){
    var col=it.okng==='OK'?'#1976d2':'#d32f2f';
    h+='<div class="hist-item"><div style="flex:1;overflow:hidden"><div style="font-size:12px;color:#666;margin-bottom:4px">'+it.date+'</div><div style="font-size:13px;font-family:monospace;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">'+it.barcode+'</div></div><div style="font-weight:bold;color:'+col+';margin:0 10px">'+it.okng+'</div><button onclick="processBarcode(historyList['+i+'].barcode)" style="padding:6px 12px;background:#006eb8;color:#fff;border:none;border-radius:4px">ë³´ê¸°</button></div>';
  });
  el.innerHTML=h;
}

function clearHistory(){
  if(confirm('ì „ì²´ ì´ë ¥ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')){historyList=[];renderHistory();}
}

function startScan(){
  document.getElementById('scannerOverlay').style.display='flex';
  if (!html5QrCode) html5QrCode = new Html5Qrcode("qr-reader");
  html5QrCode.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: { width: 250, height: 250 } },
    function(dt) { closeScanner(); processBarcode(dt); },
    function(err) {}
  ).catch(function(e) { alert("ì¹´ë©”ë¼ ì ‘ê·¼ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."); closeScanner(); });
}

function closeScanner(){
  if(html5QrCode && html5QrCode.isScanning) html5QrCode.stop().then(function(){html5QrCode.clear();});
  document.getElementById('scannerOverlay').style.display='none';
}

var galleryInput=document.getElementById('galleryInput');
function openGallery(){galleryInput.value='';galleryInput.click();}
galleryInput.addEventListener('change',function(e){
  var file=e.target.files[0];if(!file)return;
  if (!html5QrCode) html5QrCode = new Html5Qrcode("qr-reader"); 
  html5QrCode.scanFile(file, true).then(function(dt) {
    processBarcode(dt);
  }).catch(function(err) {
    alert("ë°”ì½”ë“œë¥¼ ì¸ì‹í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
  });
});

setLang('ko');
</script>
</body>
</html>
